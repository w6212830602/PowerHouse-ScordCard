<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ScoreCard.ViewModels"
             xmlns:models="clr-namespace:ScoreCard.Models"
             xmlns:controls="clr-namespace:ScoreCard.Controls"
             xmlns:converts="clr-namespace:ScoreCard.Converts"
             x:Class="ScoreCard.Views.DetailedSalesPage"
             x:DataType="viewmodels:DetailedSalesViewModel"
             BackgroundColor="#F8F9FA"
             Title="Sales Analysis - Detailed">

    <ContentPage.Resources>
        <converts:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <converts:BoolToStringConverter x:Key="BoolToStringConverter"/>
        <converts:CurrencyConverter x:Key="CurrencyConverter"/>
        <converts:TotalAgencyCommissionConverter x:Key="TotalAgencyCommissionConverter"/>
        <converts:TotalBuyResellCommissionConverter x:Key="TotalBuyResellCommissionConverter"/>
        <converts:TotalCommissionConverter x:Key="TotalCommissionConverter"/>
        <converts:TotalPOValueConverter x:Key="TotalPOValueConverter"/>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- é é¦–æŽ§åˆ¶å€åŸŸ -->
        <Grid Grid.Row="0" 
              Padding="20,10"
              BackgroundColor="White"
              ColumnDefinitions="Auto,*,Auto"
              RowDefinitions="Auto,Auto">

            <!-- è©³ç´°é é¢çš„è¦–åœ–é¡žåž‹åˆ‡æ› (Summary/Detailed) -->
            <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Margin="0,0,0,10">
                <Border Stroke="#FF3B30"
            StrokeThickness="1"
            BackgroundColor="#F0F0F0"
            StrokeShape="RoundRectangle 4,0,0,4"
            HeightRequest="36">
                    <Label Text="Summary"
               TextColor="#333333"
               VerticalOptions="Center"
               Margin="20,0"/>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NavigateToSummaryCommand}"/>
                    </Border.GestureRecognizers>
                </Border>
                <Border Stroke="#FF3B30"
            StrokeThickness="1"
            BackgroundColor="#FF3B30"
            StrokeShape="RoundRectangle 0,4,4,0"
            HeightRequest="36">
                    <Label Text="Detailed"
               TextColor="White"
               VerticalOptions="Center"
               Margin="20,0"/>
                </Border>
            </HorizontalStackLayout>

            <!-- æ—¥æœŸç¯„åœé¸æ“‡å™¨ -->
            <controls:CustomDatePicker Grid.Row="0" Grid.Column="2"
                                       StartDate="{Binding StartDate, Mode=TwoWay}" 
                                       EndDate="{Binding EndDate, Mode=TwoWay}"/>
            <!-- ç”¢å“/éŠ·å”®ä»£è¡¨åˆ‡æ› -->
            <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Spacing="0">
                <Border Stroke="#E2E8F0"
            StrokeThickness="1"
            BackgroundColor="{Binding IsProductView, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3B30,#F0F0F0'}"
            StrokeShape="RoundRectangle 4,0,0,4"
            HeightRequest="36">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ChangeViewCommand}" CommandParameter="ByProduct"/>
                    </Border.GestureRecognizers>
                    <Label Text="By Product"
               TextColor="{Binding IsProductView, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White,#333333'}"
               VerticalOptions="Center"
               FontAttributes="{Binding IsProductView, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Bold|Normal'}"
               Margin="15,0"/>
                </Border>
                <Border Stroke="#E2E8F0"
            StrokeThickness="1"
            BackgroundColor="{Binding IsRepView, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3B30,#F0F0F0'}"
            StrokeShape="RoundRectangle 0,4,4,0"
            HeightRequest="36">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ChangeViewCommand}" CommandParameter="ByRep"/>
                    </Border.GestureRecognizers>
                    <Label Text="By Rep"
               TextColor="{Binding IsRepView, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White,#333333'}"
               VerticalOptions="Center"
               FontAttributes="{Binding IsRepView, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Bold|Normal'}"
               Margin="15,0"/>
                </Border>
            </HorizontalStackLayout>


            <!-- åŒ¯å‡ºæŒ‰éˆ•å’ŒéŠ·å”®ä»£è¡¨ç¯©é¸å™¨ -->
            <Grid Grid.Row="1" Grid.Column="2" ColumnDefinitions="Auto,*">
                <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                <Border Grid.Column="0"
                        Stroke="#E2E8F0"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 4"
                        HeightRequest="36">
                    <Grid ColumnDefinitions="Auto,Auto" Margin="12,0">
                        <Label Grid.Column="0"
                               Text="â†“"
                               FontSize="16"
                               VerticalOptions="Center"/>
                        <Label Grid.Column="1"
                               Text="Export"
                               Margin="6,0,0,0"
                               VerticalOptions="Center"/>
                    </Grid>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleExportOptionsCommand}"/>
                    </Border.GestureRecognizers>
                </Border>

                <!-- éŠ·å”®ä»£è¡¨ç¯©é¸å™¨ -->
                <Border Grid.Column="1"
        Stroke="#E2E8F0"
        StrokeThickness="1"
        StrokeShape="RoundRectangle 4"
        HeightRequest="36"
        Margin="10,0,0,0">
                    <HorizontalStackLayout>
                        <Picker Title="Select Sales Rep"
                ItemsSource="{Binding SalesReps}"
                SelectedItem="{Binding SelectedSalesRep, Mode=TwoWay}"
                WidthRequest="200"
                Margin="10,0"/>
                    </HorizontalStackLayout>
                </Border>

                <!-- åŒ¯å‡ºé¸é …å½ˆå‡ºè¦–çª— -->
                <Border Grid.Column="0" Grid.ColumnSpan="2"
                        IsVisible="{Binding IsExportOptionsVisible}"
                        Stroke="#E2E8F0"
                        StrokeThickness="1"
                        BackgroundColor="White"
                        StrokeShape="RoundRectangle 4"
                        VerticalOptions="Start"
                        HorizontalOptions="Start"
                        Margin="0,40,0,0"
                        ZIndex="100">
                    <VerticalStackLayout WidthRequest="200">
                        <!-- Excel åŒ¯å‡º -->
                        <Border BackgroundColor="Transparent"
                                StrokeShape="Rectangle">
                            <Grid ColumnDefinitions="Auto,*" Padding="12">
                                <Label Grid.Column="0"
                                       Text="E"
                                       FontSize="16"
                                       TextColor="#217346"
                                       VerticalOptions="Center"/>
                                <VerticalStackLayout Grid.Column="1" Margin="10,0,0,0">
                                    <Label Text="Export to Excel"
                                           FontSize="14"/>
                                    <Label Text="Download as .xlsx file"
                                           FontSize="12"
                                           TextColor="#666666"/>
                                </VerticalStackLayout>
                            </Grid>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ExportCommand}" CommandParameter="Excel"/>
                            </Border.GestureRecognizers>
                        </Border>

                        <!-- PDF åŒ¯å‡º -->
                        <Border BackgroundColor="Transparent"
                                StrokeShape="Rectangle">
                            <Grid ColumnDefinitions="Auto,*" Padding="12">
                                <Label Grid.Column="0"
                                       Text="P"
                                       FontSize="16"
                                       TextColor="#F40F02"
                                       VerticalOptions="Center"/>
                                <VerticalStackLayout Grid.Column="1" Margin="10,0,0,0">
                                    <Label Text="Export to PDF"
                                           FontSize="14"/>
                                    <Label Text="Download as .pdf file"
                                           FontSize="12"
                                           TextColor="#666666"/>
                                </VerticalStackLayout>
                            </Grid>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ExportCommand}" CommandParameter="PDF"/>
                            </Border.GestureRecognizers>
                        </Border>

                        <!-- CSV åŒ¯å‡º -->
                        <Border BackgroundColor="Transparent"
                                StrokeShape="Rectangle">
                            <Grid ColumnDefinitions="Auto,*" Padding="12">
                                <Label Grid.Column="0"
                                       Text="C"
                                       FontSize="16"
                                       TextColor="#00A14B"
                                       VerticalOptions="Center"/>
                                <VerticalStackLayout Grid.Column="1" Margin="10,0,0,0">
                                    <Label Text="Export to CSV"
                                           FontSize="14"/>
                                    <Label Text="Download as .csv file"
                                           FontSize="12"
                                           TextColor="#666666"/>
                                </VerticalStackLayout>
                            </Grid>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ExportCommand}" CommandParameter="CSV"/>
                            </Border.GestureRecognizers>
                        </Border>

                        <!-- åˆ—å°é¸é … -->
                        <Border BackgroundColor="Transparent"
                                StrokeShape="Rectangle">
                            <Grid ColumnDefinitions="Auto,*" Padding="12">
                                <Label Grid.Column="0"
                                       Text="ðŸ–¨ï¸"
                                       FontSize="16"
                                       VerticalOptions="Center"/>
                                <VerticalStackLayout Grid.Column="1" Margin="10,0,0,0">
                                    <Label Text="Print"
                                           FontSize="14"/>
                                    <Label Text="Print current report"
                                           FontSize="12"
                                           TextColor="#666666"/>
                                </VerticalStackLayout>
                            </Grid>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ExportCommand}" CommandParameter="Print"/>
                            </Border.GestureRecognizers>
                        </Border>
                    </VerticalStackLayout>
                </Border>
            </Grid>
        </Grid>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="20" Spacing="20">
                <!-- æ¨™é¡Œå’ŒéŠ·å”®å ±è¡¨ -->
                <VerticalStackLayout Spacing="20">
                    <!-- æ¨™é¡Œ -->
                    <Label Text="Sales Analysis"
                           FontSize="24"
                           FontAttributes="Bold"/>

                    <!-- F25 - éŠ·å”®ä»£è¡¨æŒ‰ç”¢å“é¡žåž‹çš„å‚­é‡‘ -->
                    <Border Stroke="#E5E7EB"
                            StrokeThickness="1"
                            BackgroundColor="White">
                        <VerticalStackLayout>
                            <Label Text="F25 - Sales Rep Commission by Product Type (Margin Achieved)"
                                   Padding="15"
                                   FontSize="16"
                                   FontAttributes="Bold"/>

                            <!-- ç”¢å“è¦–åœ– -->
                            <VerticalStackLayout IsVisible="{Binding IsProductView}">
                                <!-- è¡¨æ ¼æ¨™é¡Œ -->
                                <Grid ColumnDefinitions="3*,2*,2*,2*,2*" 
                                      BackgroundColor="#F9FAFB"
                                      Padding="15,10">
                                    <Label Grid.Column="0" Text="Product Type" FontAttributes="Bold"/>
                                    <Label Grid.Column="1" Text="Agency Comm." FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="Buy Resell Comm." FontAttributes="Bold"/>
                                    <Label Grid.Column="3" Text="Total Commission" FontAttributes="Bold"/>
                                    <Label Grid.Column="4" Text="% of Grand Total" FontAttributes="Bold"/>
                                </Grid>

                                <!-- ç”¢å“æ•¸æ“š -->
                                <CollectionView ItemsSource="{Binding ProductSalesData}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:ProductSalesData">
                                            <!-- æ·»åŠ ç¨ç‰¹è­˜åˆ¥éµ -->
                                            <Grid x:Name="ProductRow" 
                  AutomationId="{Binding ProductType}"
                  ColumnDefinitions="3*,2*,2*,2*,2*" 
                  Padding="15,12">
                                                <Label Grid.Column="0" Text="{Binding ProductType}"/>
                                                <Label Grid.Column="1" Text="{Binding AgencyCommission, StringFormat='${0:N2}'}"/>
                                                <Label Grid.Column="2" Text="{Binding BuyResellCommission, StringFormat='${0:N2}'}"/>
                                                <Label Grid.Column="3" Text="{Binding TotalCommission, StringFormat='${0:N2}'}"/>
                                                <Label Grid.Column="4" Text="{Binding PercentageOfTotal, StringFormat='{0:N1}%'}"/>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>

                                <!-- ç¸½è¨ˆè¡Œ -->
                                <Grid ColumnDefinitions="3*,2*,2*,2*,2*" 
                                      BackgroundColor="#F0F9FF"
                                      Padding="15,12">
                                    <Label Grid.Column="0" Text="Grand Total" FontAttributes="Bold"/>
                                    <Label Grid.Column="1" Text="$1,560,638.91" FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="$133,267.32" FontAttributes="Bold"/>
                                    <Label Grid.Column="3" Text="$1,693,966.23" FontAttributes="Bold"/>
                                    <Label Grid.Column="4" Text="100.00%" FontAttributes="Bold"/>
                                </Grid>
                            </VerticalStackLayout>

                            <!-- éŠ·å”®ä»£è¡¨è¦–åœ– -->
                            <VerticalStackLayout IsVisible="{Binding IsRepView}">
                                <!-- è¡¨æ ¼æ¨™é¡Œ -->
                                <Grid ColumnDefinitions="60,3*,2*,2*,2*" 
                                      BackgroundColor="#F9FAFB"
                                      Padding="15,10">
                                    <Label Grid.Column="0" Text="Rank" FontAttributes="Bold" HorizontalOptions="Center"/>
                                    <Label Grid.Column="1" Text="Sales Rep" FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="Agency Comm." FontAttributes="Bold"/>
                                    <Label Grid.Column="3" Text="Buy Resell Comm." FontAttributes="Bold"/>
                                    <Label Grid.Column="4" Text="Total Commission" FontAttributes="Bold"/>
                                </Grid>

                                <!-- éŠ·å”®ä»£è¡¨æ•¸æ“š -->
                                <CollectionView ItemsSource="{Binding SalesRepData}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:SalesLeaderboardItem">
                                            <Grid ColumnDefinitions="60,3*,2*,2*,2*" Padding="15,12">
                                                <Label Grid.Column="0" Text="{Binding Rank}" HorizontalOptions="Center"/>
                                                <Label Grid.Column="1" Text="{Binding SalesRep}"/>
                                                <Label Grid.Column="2" Text="{Binding AgencyCommission, StringFormat='${0:N2}'}"/>
                                                <Label Grid.Column="3" Text="{Binding BuyResellCommission, StringFormat='${0:N2}'}"/>
                                                <Label Grid.Column="4" Text="{Binding TotalCommission, StringFormat='${0:N2}'}"/>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>

                                <!-- ç¸½è¨ˆè¡Œ -->
                                <Grid ColumnDefinitions="60,3*,2*,2*,2*" 
                                      BackgroundColor="#F0F9FF"
                                      Padding="15,12">
                                    <Label Grid.Column="1" Text="Grand Total" FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="$183,839.95" FontAttributes="Bold"/>
                                    <Label Grid.Column="3" Text="$3,816.57" FontAttributes="Bold"/>
                                    <Label Grid.Column="4" Text="$187,656.52" FontAttributes="Bold"/>
                                </Grid>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Sexy Report - Who's POs are bigger -->
                    <Border Stroke="#E5E7EB"
                            StrokeThickness="1"
                            BackgroundColor="White">
                        <VerticalStackLayout>
                            <Label Text="Sexy Report - Who's POs are bigger"
                                   Padding="15"
                                   FontSize="16"
                                   FontAttributes="Bold"/>

                            <!-- ç”¢å“è¦–åœ– -->
                            <VerticalStackLayout IsVisible="{Binding IsProductView}">
                                <!-- è¡¨æ ¼æ¨™é¡Œ -->
                                <Grid ColumnDefinitions="3*,2*,2*" 
                                      BackgroundColor="#F9FAFB"
                                      Padding="15,10">
                                    <Label Grid.Column="0" Text="Product Type" FontAttributes="Bold"/>
                                    <Label Grid.Column="1" Text="PO Value" FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="% of Grand Total" FontAttributes="Bold"/>
                                </Grid>

                                <!-- ç”¢å“æ•¸æ“š -->
                                <CollectionView ItemsSource="{Binding ProductSalesData}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:ProductSalesData">
                                            <Grid ColumnDefinitions="3*,2*,2*" Padding="15,12">
                                                <Label Grid.Column="0" Text="{Binding ProductType}"/>
                                                <Label Grid.Column="1" Text="{Binding POValue, StringFormat='${0:N2}'}"/>
                                                <Label Grid.Column="2" Text="{Binding PercentageOfTotal, StringFormat='{0:N1}%'}"/>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>

                                <!-- ç¸½è¨ˆè¡Œ -->
                                <Grid ColumnDefinitions="3*,2*,2*" 
                                      BackgroundColor="#F0F9FF"
                                      Padding="15,12">
                                    <Label Grid.Column="0" Text="Grand Total" FontAttributes="Bold"/>
                                    <Label Grid.Column="1" Text="$17,758,397.94" FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="100.00%" FontAttributes="Bold"/>
                                </Grid>
                            </VerticalStackLayout>

                            <!-- éŠ·å”®ä»£è¡¨è¦–åœ– -->
                            <VerticalStackLayout IsVisible="{Binding IsRepView}">
                                <!-- è¡¨æ ¼æ¨™é¡Œ -->
                                <Grid ColumnDefinitions="3*,2*,2*" 
                                      BackgroundColor="#F9FAFB"
                                      Padding="15,10">
                                    <Label Grid.Column="0" Text="Product Type" FontAttributes="Bold"/>
                                    <Label Grid.Column="1" Text="Sum of PO Value" FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="% of PO Value" FontAttributes="Bold"/>
                                </Grid>

                                <!-- éŠ·å”®ä»£è¡¨ PO æ•¸æ“š -->
                                <Grid ColumnDefinitions="3*,2*,2*" Padding="15,12">
                                    <Label Grid.Column="0" Text="Channel"/>
                                    <Label Grid.Column="1" Text="$70,124.50"/>
                                    <Label Grid.Column="2" Text="3.52%"/>
                                </Grid>

                                <Grid ColumnDefinitions="3*,2*,2*" Padding="15,12">
                                    <Label Grid.Column="0" Text="Thermal"/>
                                    <Label Grid.Column="1" Text="$1,324,853.30"/>
                                    <Label Grid.Column="2" Text="96.48%"/>
                                </Grid>

                                <!-- ç¸½è¨ˆè¡Œ -->
                                <Grid ColumnDefinitions="3*,2*,2*" 
                                      BackgroundColor="#F0F9FF"
                                      Padding="15,12">
                                    <Label Grid.Column="0" Text="Grand Total" FontAttributes="Bold"/>
                                    <Label Grid.Column="1" Text="$1,394,384.40" FontAttributes="Bold"/>
                                    <Label Grid.Column="2" Text="100.00%" FontAttributes="Bold"/>
                                </Grid>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

        <!-- åŠ è¼‰æŒ‡ç¤ºå™¨ -->
        <Grid Grid.RowSpan="2" 
              BackgroundColor="#80000000"
              IsVisible="{Binding IsLoading}">
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                             HorizontalOptions="Center" 
                             VerticalOptions="Center"/>
        </Grid>
    </Grid>
</ContentPage>