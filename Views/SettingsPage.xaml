<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ScoreCard.ViewModels"
             xmlns:models="clr-namespace:ScoreCard.Models"
             xmlns:converts="clr-namespace:ScoreCard.Converts"
             x:Class="ScoreCard.Views.SettingsPage"
             x:DataType="viewmodels:SettingsViewModel"
             BackgroundColor="#F8F9FA"
             Title="Settings">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converts:StringEqualsConverter x:Key="StringEqualsConverter"/>
            <converts:BoolToColorConverter x:Key="BoolToColorConverter"/>
            <converts:InverseBoolToColorConverter x:Key="InverseBoolToColorConverter"/>
            <converts:BoolToStringConverter x:Key="BoolToStringConverter"/>
            <converts:InverseBoolToStringConverter x:Key="InverseBoolToStringConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- Header with tabs -->
        <Grid Grid.Row="0" Padding="20,0" BackgroundColor="White">
            <HorizontalStackLayout Spacing="0">
                <!-- Company Target Tab -->
                <Border Stroke="#E5E7EB"
                        StrokeThickness="1"
                        BackgroundColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,#EFF6FF,White'}"
                        Padding="20,10">
                    <Label Text="Company Target"
                           TextColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,#2563EB,#6B7280'}"
                           FontAttributes="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,Bold,None'}"/>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="CompanyTarget"/>
                    </Border.GestureRecognizers>
                </Border>

                <!-- Individual Target Tab -->
                <Border Stroke="#E5E7EB"
                        StrokeThickness="1"
                        BackgroundColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,#EFF6FF,White'}"
                        Padding="20,10">
                    <Label Text="Individual Target"
                           TextColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,#2563EB,#6B7280'}"
                           FontAttributes="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,Bold,None'}"/>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="IndividualTarget"/>
                    </Border.GestureRecognizers>
                </Border>

                <!-- LOB Targets Tab -->
                <Border Stroke="#E5E7EB"
                        StrokeThickness="1"
                        BackgroundColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='LOBTargets,#EFF6FF,White'}"
                        Padding="20,10">
                    <Label Text="LOB Targets"
                           TextColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='LOBTargets,#2563EB,#6B7280'}"
                           FontAttributes="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='LOBTargets,Bold,None'}"/>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="LOBTargets"/>
                    </Border.GestureRecognizers>
                </Border>
            </HorizontalStackLayout>
        </Grid>

        <!-- Main content area -->
        <Grid Grid.Row="1" Padding="20">
            <!-- Edit/Save button in top-right corner -->
            <Grid ColumnDefinitions="Auto,*,Auto" HorizontalOptions="Fill" VerticalOptions="Start" Margin="0,10,0,20">
                <!-- Fiscal Year Selector (for Individual and LOB tabs) -->
                <Picker Grid.Column="0" 
                        Title="Select Fiscal Year"
                        ItemsSource="{Binding FiscalYears}"
                        SelectedItem="{Binding SelectedFiscalYear}"
                        IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,False,True'}"
                        WidthRequest="150"/>

                <!-- Add Fiscal Year Button (only for Company Target tab) -->
                <Button Grid.Column="0"
                        Text="+ Add Fiscal Year"
                        Command="{Binding AddFiscalYearCommand}"
                        IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,True,False'}"
                        BackgroundColor="#3B82F6"
                        TextColor="White"
                        HeightRequest="36"
                        Padding="15,5"
                        IsEnabled="{Binding IsEditingTargets}"/>

                <!-- Edit/Save Buttons -->
                <Button Grid.Column="2"
                        Text="Edit Targets"
                        Command="{Binding ToggleEditModeCommand}"
                        TextColor="White"
                        BackgroundColor="#FF3B30"
                        Padding="15,5"
                        HeightRequest="36"
                        HorizontalOptions="End"
                        IsVisible="{Binding IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>

                <Button Grid.Column="2"
                        Text="Save Changes"
                        Command="{Binding SaveChangesCommand}"
                        TextColor="White"
                        BackgroundColor="#10B981"
                        Padding="15,5"
                        HeightRequest="36"
                        HorizontalOptions="End"
                        IsVisible="{Binding IsEditingTargets}"/>
            </Grid>

            <!-- Content Area -->
            <ScrollView Margin="0,60,0,0">
                <!-- Company Target Tab Content -->
                <VerticalStackLayout IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,True,False'}"
                                    Spacing="20">
                    <Border Stroke="#E5E7EB"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 8"
                            BackgroundColor="White">
                        <VerticalStackLayout>
                            <!-- Table Header -->
                            <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                BackgroundColor="#F9FAFB"
                                Padding="16,12">
                                <Label Grid.Column="0" Text="Fiscal Year" FontAttributes="Bold"/>
                                <Label Grid.Column="1" Text="Annual Target" FontAttributes="Bold"/>
                                <Label Grid.Column="2" Text="Q1 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="3" Text="Q2 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="4" Text="Q3 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="5" Text="Q4 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="6" Text="Actions" FontAttributes="Bold" IsVisible="{Binding IsEditingTargets}"/>
                            </Grid>

                            <!-- Table Content -->
                            <CollectionView ItemsSource="{Binding CompanyTargets}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:FiscalYearTarget">
                                        <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                            Padding="16,12">
                                            <Label Grid.Column="0" Text="{Binding FiscalYear, StringFormat='FY {0}'}"/>

                                            <!-- Targets - conditionally editable -->
                                            <Grid Grid.Column="1">
                                                <Label Text="{Binding AnnualTarget, StringFormat='${0:N0}'}"
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding AnnualTarget, StringFormat='{0:N0}'}" 
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                    Keyboard="Numeric"
                                                    ReturnType="Done"
                                                    ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="2">
                                                <Label Text="{Binding Q1Target, StringFormat='${0:N0}'}"
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q1Target, StringFormat='{0:N0}'}" 
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                    Keyboard="Numeric"
                                                    ReturnType="Done"
                                                    ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="3">
                                                <Label Text="{Binding Q2Target, StringFormat='${0:N0}'}"
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q2Target, StringFormat='{0:N0}'}" 
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                    Keyboard="Numeric"
                                                    ReturnType="Done"
                                                    ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="4">
                                                <Label Text="{Binding Q3Target, StringFormat='${0:N0}'}"
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q3Target, StringFormat='{0:N0}'}" 
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                    Keyboard="Numeric"
                                                    ReturnType="Done"
                                                    ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="5">
                                                <Label Text="{Binding Q4Target, StringFormat='${0:N0}'}"
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q4Target, StringFormat='{0:N0}'}" 
                                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                    Keyboard="Numeric"
                                                    ReturnType="Done"
                                                    ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- Actions for editing -->
                                            <HorizontalStackLayout Grid.Column="6" 
                                                                IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                                Spacing="5">
                                                <!-- Update Annual Target based on quarters -->
                                                <Button Text="↑"
                                                        ToolTipProperties.Text="Update Annual Target from Quarters"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=UpdateAnnualTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>

                                                <!-- Distribute Annual Target to quarters -->
                                                <Button Text="↓"
                                                        ToolTipProperties.Text="Distribute Annual Target to Quarters"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=DistributeTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#2196F3"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

                <!-- Individual Target Tab Content -->
                <VerticalStackLayout IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,True,False'}"
                                    Spacing="20">
                    <Grid ColumnDefinitions="*,Auto" VerticalOptions="Start">
                        <!-- Add Reps Button -->
                        <Button Grid.Column="1"
                                Text="+ Add Reps"
                                Command="{Binding AddSalesRepCommand}"
                                IsVisible="{Binding IsEditingTargets}"
                                BackgroundColor="#3B82F6"
                                TextColor="White"
                                HeightRequest="36"
                                Padding="15,5"/>
                    </Grid>

                    <Border Stroke="#E5E7EB"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 8"
                            BackgroundColor="White">
                        <VerticalStackLayout>
                            <!-- Table Header -->
                            <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                BackgroundColor="#F9FAFB"
                                Padding="16,12">
                                <Label Grid.Column="0" Text="Sales Rep" FontAttributes="Bold"/>
                                <Label Grid.Column="1" Text="Annual Target" FontAttributes="Bold"/>
                                <Label Grid.Column="2" Text="Q1 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="3" Text="Q2 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="4" Text="Q3 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="5" Text="Q4 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="6" Text="Actions" FontAttributes="Bold" IsVisible="{Binding IsEditingTargets}"/>
                            </Grid>

                            <!-- Table Content -->
                            <CollectionView ItemsSource="{Binding SalesRepTargets}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="viewmodels:SalesRepTarget">
                                        <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                              Padding="16,12">
                                            <Grid Grid.Column="0">
                                                <Label Text="{Binding SalesRep}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding SalesRep}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- Targets - conditionally editable -->
                                            <Grid Grid.Column="1">
                                                <Label Text="{Binding AnnualTarget, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding AnnualTarget, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="2">
                                                <Label Text="{Binding Q1Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q1Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="3">
                                                <Label Text="{Binding Q2Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q2Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="4">
                                                <Label Text="{Binding Q3Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q3Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="5">
                                                <Label Text="{Binding Q4Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q4Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- Actions for editing -->
                                            <HorizontalStackLayout Grid.Column="6" 
                                                                  IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                                  Spacing="5">
                                                <!-- Update Annual Target based on quarters -->
                                                <Button Text="↑"
                                                        ToolTipProperties.Text="Update Annual Target from Quarters"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=UpdateAnnualTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>

                                                <!-- Distribute Annual Target to quarters -->
                                                <Button Text="↓"
                                                        ToolTipProperties.Text="Distribute Annual Target to Quarters"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=DistributeTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#2196F3"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>

                                                <!-- Remove Rep -->
                                                <Button Text="🗑"
                                                        ToolTipProperties.Text="Remove Sales Rep"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=RemoveSalesRepCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#F44336"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

                <!-- LOB Targets Tab Content -->
                <VerticalStackLayout IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='LOBTargets,True,False'}"
                                     Spacing="20">
                    <Grid ColumnDefinitions="*,Auto" VerticalOptions="Start">
                        <!-- Add LOB Button -->
                        <Button Grid.Column="1"
                                Text="+ Add LOB"
                                Command="{Binding AddLOBCommand}"
                                IsVisible="{Binding IsEditingTargets}"
                                BackgroundColor="#3B82F6"
                                TextColor="White"
                                HeightRequest="36"
                                Padding="15,5"/>
                    </Grid>

                    <Border Stroke="#E5E7EB"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 8"
                            BackgroundColor="White">
                        <VerticalStackLayout>
                            <!-- Table Header -->
                            <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                  BackgroundColor="#F9FAFB"
                                  Padding="16,12">
                                <Label Grid.Column="0" Text="LOB" FontAttributes="Bold"/>
                                <Label Grid.Column="1" Text="Annual Target" FontAttributes="Bold"/>
                                <Label Grid.Column="2" Text="Q1 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="3" Text="Q2 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="4" Text="Q3 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="5" Text="Q4 Target" FontAttributes="Bold"/>
                                <Label Grid.Column="6" Text="Actions" FontAttributes="Bold" IsVisible="{Binding IsEditingTargets}"/>
                            </Grid>

                            <!-- Table Content -->
                            <CollectionView ItemsSource="{Binding LobTargets}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="viewmodels:LOBTarget">
                                        <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                              Padding="16,12">
                                            <Grid Grid.Column="0">
                                                <Label Text="{Binding LOB}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding LOB}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- Targets - conditionally editable -->
                                            <Grid Grid.Column="1">
                                                <Label Text="{Binding AnnualTarget, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding AnnualTarget, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="2">
                                                <Label Text="{Binding Q1Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q1Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="3">
                                                <Label Text="{Binding Q2Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q2Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="4">
                                                <Label Text="{Binding Q3Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q3Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="5">
                                                <Label Text="{Binding Q4Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q4Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- Actions for editing -->
                                            <HorizontalStackLayout Grid.Column="6" 
                                                                  IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                                  Spacing="5">
                                                <!-- Update Annual Target based on quarters -->
                                                <Button Text="↑"
                                                        ToolTipProperties.Text="Update Annual Target from Quarters"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=UpdateAnnualTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>

                                                <!-- Distribute Annual Target to quarters -->
                                                <Button Text="↓"
                                                        ToolTipProperties.Text="Distribute Annual Target to Quarters"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=DistributeTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#2196F3"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>

                                                <!-- Remove LOB -->
                                                <Button Text="🗑"
                                                        ToolTipProperties.Text="Remove LOB"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=RemoveLOBCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#F44336"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </ScrollView>

            <!-- Loading indicator -->
            <Grid BackgroundColor="#80000000" 
                  IsVisible="{Binding IsLoading}">
                <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                  Color="#FF3B30"
                                  HeightRequest="50" 
                                  WidthRequest="50"
                                  HorizontalOptions="Center" 
                                  VerticalOptions="Center"/>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>