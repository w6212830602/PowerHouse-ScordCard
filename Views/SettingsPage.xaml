<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ScoreCard.ViewModels"
             xmlns:models="clr-namespace:ScoreCard.Models"
             xmlns:converts="clr-namespace:ScoreCard.Converts"
             x:Class="ScoreCard.Views.SettingsPage"
             x:DataType="viewmodels:SettingsViewModel"
             BackgroundColor="#F8F9FA"
             Title="è¨­å®š">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converts:StringEqualsConverter x:Key="StringEqualsConverter"/>
            <converts:BoolToColorConverter x:Key="BoolToColorConverter"/>
            <converts:InverseBoolToColorConverter x:Key="InverseBoolToColorConverter"/>
            <converts:BoolToStringConverter x:Key="BoolToStringConverter"/>
            <converts:InverseBoolToStringConverter x:Key="InverseBoolToStringConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- é é¦–å°Žè¦½å€ -->
        <Grid Grid.Row="0" Padding="20,10" BackgroundColor="White">
            <HorizontalStackLayout Spacing="0">
                <!-- å…¬å¸ç›®æ¨™æ¨™ç±¤ -->
                <Border Stroke="#E5E7EB"
                        StrokeThickness="1"
                        BackgroundColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,#EFF6FF,White'}"
                        Padding="20,10">
                    <Label Text="å…¬å¸ç›®æ¨™"
                           TextColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,#2563EB,#6B7280'}"
                           FontAttributes="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,Bold,None'}"/>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="CompanyTarget"/>
                    </Border.GestureRecognizers>
                </Border>

                <!-- å€‹äººç›®æ¨™æ¨™ç±¤ -->
                <Border Stroke="#E5E7EB"
                        StrokeThickness="1"
                        BackgroundColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,#EFF6FF,White'}"
                        Padding="20,10">
                    <Label Text="å€‹äººç›®æ¨™"
                           TextColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,#2563EB,#6B7280'}"
                           FontAttributes="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,Bold,None'}"/>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="IndividualTarget"/>
                    </Border.GestureRecognizers>
                </Border>

                <!-- LOB ç›®æ¨™æ¨™ç±¤ -->
                <Border Stroke="#E5E7EB"
        StrokeThickness="1"
        BackgroundColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='LOBTargets,#EFF6FF,White'}"
        Padding="20,10">
                    <Label Text="Product Line Target"
           TextColor="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='LOBTargets,#2563EB,#6B7280'}"
           FontAttributes="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='LOBTargets,Bold,None'}"/>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="LOBTargets"/>
                    </Border.GestureRecognizers>
                </Border>
            </HorizontalStackLayout>
        </Grid>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <Grid Grid.Row="1" Padding="20">
            <!-- é ‚éƒ¨æŽ§åˆ¶å€åŸŸ -->
            <Grid ColumnDefinitions="Auto,*,Auto" HorizontalOptions="Fill" VerticalOptions="Start" Margin="0,10,0,20">
                <!-- è²¡å¹´é¸æ“‡å™¨ï¼ˆé©ç”¨æ–¼å€‹äººå’Œ LOB æ¨™ç±¤ï¼‰ -->
                <Grid Grid.Column="0" ColumnDefinitions="Auto,*" IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,False,True'}">
                    <Label Text="é¸æ“‡è²¡å¹´ï¼š" VerticalOptions="Center" Margin="0,0,10,0"/>
                    <Picker Grid.Column="1"
                            ItemsSource="{Binding FiscalYears}"
                            SelectedItem="{Binding SelectedFiscalYear}"
                            WidthRequest="150"/>
                </Grid>

                <!-- æ·»åŠ è²¡å¹´æŒ‰éˆ•ï¼ˆåƒ…é©ç”¨æ–¼å…¬å¸ç›®æ¨™æ¨™ç±¤ï¼‰ -->
                <Button Grid.Column="0"
                        Text="+ æ·»åŠ è²¡å¹´"
                        Command="{Binding AddFiscalYearCommand}"
                        IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,True,False'}"
                        BackgroundColor="#3B82F6"
                        TextColor="White"
                        HeightRequest="36"
                        Padding="15,5"
                        IsEnabled="{Binding IsEditingTargets}"/>

                <!-- æ·»åŠ ä»£è¡¨/æ·»åŠ  LOB æŒ‰éˆ•ï¼ˆæ ¹æ“šé¸å®šæ¨™ç±¤é¡¯ç¤ºï¼‰ -->
                <Button Grid.Column="1" HorizontalOptions="End" Margin="0,0,10,0"
                        Text="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,+ æ·»åŠ ä»£è¡¨,+ æ·»åŠ ç”¢å“ç·š'}"
                        Command="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,AddRepCommand,AddLOBCommand'}"
                        IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,False,True'}"
                        BackgroundColor="#3B82F6"
                        TextColor="White"
                        HeightRequest="36"
                        Padding="15,5"
                        IsEnabled="{Binding IsEditingTargets}"/>

                <!-- ç·¨è¼¯/ä¿å­˜æŒ‰éˆ• -->
                <Button Grid.Column="2"
                        Text="ç·¨è¼¯ç›®æ¨™"
                        Command="{Binding ToggleEditModeCommand}"
                        TextColor="White"
                        BackgroundColor="#FF3B30"
                        Padding="15,5"
                        HeightRequest="36"
                        HorizontalOptions="End"
                        IsVisible="{Binding IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>

                <Button Grid.Column="2"
                        Text="ä¿å­˜æ›´æ”¹"
                        Command="{Binding SaveChangesCommand}"
                        TextColor="White"
                        BackgroundColor="#10B981"
                        Padding="15,5"
                        HeightRequest="36"
                        HorizontalOptions="End"
                        IsVisible="{Binding IsEditingTargets}"/>
            </Grid>

            <!-- å…§å®¹å€åŸŸ -->
            <ScrollView Margin="0,60,0,0">
                <!-- å…¬å¸ç›®æ¨™æ¨™ç±¤å…§å®¹ -->
                <VerticalStackLayout IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='CompanyTarget,True,False'}"
                                    Spacing="20">
                    <Border Stroke="#E5E7EB"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 8"
                            BackgroundColor="White">
                        <VerticalStackLayout>
                            <!-- è¡¨æ ¼æ¨™é¡Œ -->
                            <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                  BackgroundColor="#F9FAFB"
                                  Padding="16,12">
                                <Label Grid.Column="0" Text="è²¡å¹´" FontAttributes="Bold"/>
                                <Label Grid.Column="1" Text="å¹´åº¦ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="2" Text="Q1 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="3" Text="Q2 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="4" Text="Q3 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="5" Text="Q4 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="6" Text="æ“ä½œ" FontAttributes="Bold" IsVisible="{Binding IsEditingTargets}"/>
                            </Grid>

                            <!-- è¡¨æ ¼å…§å®¹ -->
                            <CollectionView ItemsSource="{Binding CompanyTargets}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:FiscalYearTarget">
                                        <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                              Padding="16,12">
                                            <Label Grid.Column="0" Text="{Binding FiscalYear, StringFormat='FY {0}'}"/>

                                            <!-- ç›®æ¨™ - æ ¹æ“šç·¨è¼¯æ¨¡å¼æ¢ä»¶é¡¯ç¤º -->
                                            <Grid Grid.Column="1">
                                                <Label Text="{Binding AnnualTarget, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding AnnualTarget, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="2">
                                                <Label Text="{Binding Q1Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q1Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="3">
                                                <Label Text="{Binding Q2Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q2Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="4">
                                                <Label Text="{Binding Q3Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q3Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="5">
                                                <Label Text="{Binding Q4Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q4Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- ç·¨è¼¯åŠŸèƒ½æŒ‰éˆ• -->
                                            <HorizontalStackLayout Grid.Column="6" 
                                                                  IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                                  Spacing="5">
                                                <!-- æ ¹æ“šå­£åº¦æ›´æ–°å¹´åº¦ç›®æ¨™ -->
                                                <Button Text="â†‘"
                                                        ToolTipProperties.Text="æ ¹æ“šå­£åº¦æ›´æ–°å¹´åº¦ç›®æ¨™"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=UpdateAnnualTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>

                                                <!-- å°‡å¹´åº¦ç›®æ¨™åˆ†é…åˆ°å­£åº¦ -->
                                                <Button Text="â†“"
                                                        ToolTipProperties.Text="å°‡å¹´åº¦ç›®æ¨™å¹³å‡åˆ†é…åˆ°å­£åº¦"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=DistributeTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#2196F3"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

                <!-- å€‹äººç›®æ¨™æ¨™ç±¤å…§å®¹ -->
                <VerticalStackLayout IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='IndividualTarget,True,False'}"
                                    Spacing="20">
                    <Border Stroke="#E5E7EB"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 8"
                            BackgroundColor="White">
                        <VerticalStackLayout>
                            <!-- è¡¨æ ¼æ¨™é¡Œ -->
                            <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                  BackgroundColor="#F9FAFB"
                                  Padding="16,12">
                                <Label Grid.Column="0" Text="éŠ·å”®ä»£è¡¨" FontAttributes="Bold"/>
                                <Label Grid.Column="1" Text="å¹´åº¦ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="2" Text="Q1 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="3" Text="Q2 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="4" Text="Q3 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="5" Text="Q4 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="6" Text="æ“ä½œ" FontAttributes="Bold" IsVisible="{Binding IsEditingTargets}"/>
                            </Grid>

                            <!-- è¡¨æ ¼å…§å®¹ -->
                            <CollectionView ItemsSource="{Binding SalesRepTargets}" 
                                          EmptyView="æ­¤è²¡å¹´å°šæœªå®šç¾©ä»»ä½•éŠ·å”®ä»£è¡¨ç›®æ¨™ã€‚">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:SalesRepTarget">
                                        <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                              Padding="16,12">
                                            <Grid Grid.Column="0">
                                                <Label Text="{Binding SalesRep}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding SalesRep}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- ç›®æ¨™ - æ ¹æ“šç·¨è¼¯æ¨¡å¼æ¢ä»¶é¡¯ç¤º -->
                                            <Grid Grid.Column="1">
                                                <Label Text="{Binding AnnualTarget, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding AnnualTarget, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="2">
                                                <Label Text="{Binding Q1Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q1Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="3">
                                                <Label Text="{Binding Q2Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q2Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="4">
                                                <Label Text="{Binding Q3Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q3Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="5">
                                                <Label Text="{Binding Q4Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q4Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- ç·¨è¼¯åŠŸèƒ½æŒ‰éˆ• -->
                                            <HorizontalStackLayout Grid.Column="6" 
                                                                  IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                                  Spacing="5">
                                                <!-- æ ¹æ“šå­£åº¦æ›´æ–°å¹´åº¦ç›®æ¨™ -->
                                                <Button Text="â†‘"
                                                        ToolTipProperties.Text="æ ¹æ“šå­£åº¦æ›´æ–°å¹´åº¦ç›®æ¨™"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=UpdateAnnualTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>

                                                <!-- å°‡å¹´åº¦ç›®æ¨™åˆ†é…åˆ°å­£åº¦ -->
                                                <Button Text="â†“"
                                                        ToolTipProperties.Text="å°‡å¹´åº¦ç›®æ¨™å¹³å‡åˆ†é…åˆ°å­£åº¦"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=DistributeTargetCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#2196F3"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>

                                                <!-- åˆªé™¤ä»£è¡¨ -->
                                                <Button Text="ðŸ—‘"
                                                        ToolTipProperties.Text="åˆªé™¤éŠ·å”®ä»£è¡¨"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=RemoveSalesRepCommand}"
                                                        CommandParameter="{Binding}"
                                                        BackgroundColor="#F44336"
                                                        TextColor="White"
                                                        WidthRequest="36"
                                                        HeightRequest="36"
                                                        Padding="0"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

                <!-- LOB ç›®æ¨™æ¨™ç±¤å…§å®¹ -->
                <VerticalStackLayout IsVisible="{Binding SelectedTab, Converter={StaticResource StringEqualsConverter}, ConverterParameter='LOBTargets,True,False'}"
                                     Spacing="20">
                    <Border Stroke="#E5E7EB"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 8"
                            BackgroundColor="White">
                        <VerticalStackLayout>
                            <!-- è¡¨æ ¼æ¨™é¡Œ -->
                            <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                  BackgroundColor="#F9FAFB"
                                  Padding="16,12">
                                <Label Grid.Column="0" Text="ç”¢å“ç·š" FontAttributes="Bold"/>
                                <Label Grid.Column="1" Text="å¹´åº¦ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="2" Text="Q1 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="3" Text="Q2 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="4" Text="Q3 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="5" Text="Q4 ç›®æ¨™" FontAttributes="Bold"/>
                                <Label Grid.Column="6" Text="æ“ä½œ" FontAttributes="Bold" IsVisible="{Binding IsEditingTargets}"/>
                            </Grid>

                            <!-- è¡¨æ ¼å…§å®¹ -->
                            <CollectionView ItemsSource="{Binding LobTargets}"
                                          EmptyView="æ­¤è²¡å¹´å°šæœªå®šç¾©ä»»ä½•ç”¢å“ç·šç›®æ¨™ã€‚">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:LOBTarget">
                                        <Grid ColumnDefinitions="2*,*,*,*,*,*,Auto"
                                              Padding="16,12">
                                            <Grid Grid.Column="0">
                                                <Label Text="{Binding LOB}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding LOB}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- ç›®æ¨™ - æ ¹æ“šç·¨è¼¯æ¨¡å¼æ¢ä»¶é¡¯ç¤º -->
                                            <Grid Grid.Column="1">
                                                <Label Text="{Binding AnnualTarget, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding AnnualTarget, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="2">
                                                <Label Text="{Binding Q1Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q1Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="3">
                                                <Label Text="{Binding Q2Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q2Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="4">
                                                <Label Text="{Binding Q3Target, StringFormat='${0:N0}'}"
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q3Target, StringFormat='{0:N0}'}" 
                                                       IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                                                       Keyboard="Numeric"
                                                       ReturnType="Done"
                                                       ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <Grid Grid.Column="5">
                                                <Label Text="{Binding Q4Target, StringFormat='${0:N0}'}"
           IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets, Converter={StaticResource InverseBoolToStringConverter}}"/>
                                                <Entry Text="{Binding Q4Target, StringFormat='{0:N0}'}" 
           IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
           Keyboard="Numeric"
           ReturnType="Done"
           ClearButtonVisibility="WhileEditing"/>
                                            </Grid>

                                            <!-- ç·¨è¼¯åŠŸèƒ½æŒ‰éˆ• -->
                                            <HorizontalStackLayout Grid.Column="6" 
                      IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=IsEditingTargets}"
                      Spacing="5">
                                                <!-- æ ¹æ“šå­£åº¦æ›´æ–°å¹´åº¦ç›®æ¨™ -->
                                                <Button Text="â†‘"
            ToolTipProperties.Text="æ ¹æ“šå­£åº¦æ›´æ–°å¹´åº¦ç›®æ¨™"
            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=UpdateAnnualTargetCommand}"
            CommandParameter="{Binding}"
            BackgroundColor="#4CAF50"
            TextColor="White"
            WidthRequest="36"
            HeightRequest="36"
            Padding="0"/>

                                                <!-- å°‡å¹´åº¦ç›®æ¨™åˆ†é…åˆ°å­£åº¦ -->
                                                <Button Text="â†“"
            ToolTipProperties.Text="å°‡å¹´åº¦ç›®æ¨™å¹³å‡åˆ†é…åˆ°å­£åº¦"
            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=DistributeTargetCommand}"
            CommandParameter="{Binding}"
            BackgroundColor="#2196F3"
            TextColor="White"
            WidthRequest="36"
            HeightRequest="36"
            Padding="0"/>

                                                <!-- åˆªé™¤LOB -->
                                                <Button Text="ðŸ—‘"
            ToolTipProperties.Text="åˆªé™¤ç”¢å“ç·š"
            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:SettingsViewModel}}, Path=RemoveLOBCommand}"
            CommandParameter="{Binding}"
            BackgroundColor="#F44336"
            TextColor="White"
            WidthRequest="36"
            HeightRequest="36"
            Padding="0"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </ScrollView>

            <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
            <Grid BackgroundColor="#80000000" 
                  IsVisible="{Binding IsLoading}">
                <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                  Color="#FF3B30"
                                  HeightRequest="50" 
                                  WidthRequest="50"
                                  HorizontalOptions="Center" 
                                  VerticalOptions="Center"/>
            </Grid>
        </Grid>

        <!-- ç‹€æ…‹æ¶ˆæ¯æ¬„ -->
        <Grid Grid.Row="2" 
              IsVisible="{Binding IsStatusMessageVisible}"
              BackgroundColor="{Binding IsStatusSuccess, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#D1FAE5,#FEE2E2'}"
              Padding="20,10">
            <Label Text="{Binding StatusMessage}"
                   TextColor="{Binding IsStatusSuccess, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#065F46,#991B1B'}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HorizontalTextAlignment="Center"/>
        </Grid>
    </Grid>
</ContentPage>